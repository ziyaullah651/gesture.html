<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Advanced Gesture Particle System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<style>
body{margin:0;overflow:hidden;background:#05050a;font-family:system-ui;color:white}
#ui{position:fixed;top:14px;left:14px;display:flex;flex-wrap:wrap;gap:8px;padding:12px;border-radius:16px;background:rgba(30,30,45,.75);backdrop-filter:blur(14px);z-index:10}
select,input,label{background:#0e0e1a;color:white;border:1px solid #333;border-radius:10px;padding:6px 10px;font-size:12px}
label{display:flex;align-items:center;gap:6px}
#hint{position:fixed;bottom:12px;left:50%;transform:translateX(-50%);font-size:12px;opacity:.7}
video{display:none}
</style>
</head>
<body>

<div id="ui">
<select id="template">
  <option value="heart">â¤ Heart</option>
  <option value="flower">ğŸŒ¸ Flower</option>
  <option value="galaxy">ğŸŒŒ Galaxy</option>
  <option value="earth">ğŸŒ Earth</option>
  <option value="mars">ğŸ”´ Mars</option>
  <option value="jupiter">ğŸŸ  Jupiter</option>
  <option value="saturn">ğŸª Saturn</option>
  <option value="fireworks">ğŸ† Fireworks</option>
</select>
<input type="color" id="color" value="#ff4dff" />
<label>Size <input id="size" type="range" min="1" max="20" value="6"></label>
<label>Count <input id="count" type="range" min="2000" max="30000" step="1000" value="12000"></label>
<button id="reload">â†» Reload</button>
</div>

<div id="hint">1 hand â†’ move | 2 hands spread â†’ expand | pinch â†’ collapse | fist â†’ explode</div>
<video id="video" autoplay playsinline></video>
<script>
const video=document.getElementById('video');
</script>

<script>
const scene=new THREE.Scene();
const camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,.1,1000);
camera.position.z=90;
const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
document.body.appendChild(renderer.domElement);
window.onresize=()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight)}

let COUNT=12000,geometry,positions,velocities,particles;
const material=new THREE.ShaderMaterial({
 uniforms:{uColor:{value:new THREE.Color('#ff4dff')},uSize:{value:6}},
 vertexShader:`uniform float uSize;void main(){vec4 mv=modelViewMatrix*vec4(position,1.);gl_PointSize=uSize*(300./-mv.z);gl_Position=projectionMatrix*mv;}`,
 fragmentShader:`uniform vec3 uColor;void main(){float d=distance(gl_PointCoord,vec2(.5));if(d>.5)discard;gl_FragColor=vec4(uColor,1.-d*2.);}`
});

let currentTemplate='heart';
const planetRadius={earth:14,mars:11,jupiter:20};

function createParticles(){
 if(particles) scene.remove(particles);
 geometry=new THREE.BufferGeometry();
 positions=new Float32Array(COUNT*3);
 velocities=new Float32Array(COUNT*3);
 geometry.setAttribute('position',new THREE.BufferAttribute(positions,3));
 particles=new THREE.Points(geometry,material);
 scene.add(particles);
 shape(currentTemplate);
}

function shape(type){
 currentTemplate=type;
 for(let i=0;i<COUNT;i++){
  let a=Math.random()*Math.PI*2,b=Math.random()*Math.PI,r=Math.random()*20,x=0,y=0,z=0;
  if(type==='heart'){x=16*Math.pow(Math.sin(a),3);y=13*Math.cos(a)-5*Math.cos(2*a)}
  if(type==='flower'){r=10*Math.sin(6*a);x=r*Math.cos(a);y=r*Math.sin(a)}
  if(type==='galaxy'){r=a*3;x=r*Math.cos(a);z=r*Math.sin(a);y=(Math.random()-.5)*4}
  if(type==='fireworks'){x=r*Math.sin(b)*Math.cos(a);y=r*Math.cos(b);z=r*Math.sin(b)*Math.sin(a)}
  if(planetRadius[type]){r=planetRadius[type];x=r*Math.sin(b)*Math.cos(a);y=r*Math.cos(b);z=r*Math.sin(b)*Math.sin(a)}
  if(type==='saturn'){r=18+Math.random()*6;x=r*Math.cos(a);z=r*Math.sin(a);y=(Math.random()-.5)*3}
  positions.set([x,y,z],i*3);
 }
 geometry.attributes.position.needsUpdate=true;
}
createParticles();

// Hand tracking
const hands=new Hands({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
hands.setOptions({maxNumHands:2,minDetectionConfidence:.7,minTrackingConfidence:.7});

let lastPalm=null,scaleTarget=1;

hands.onResults(r=>{
 if(!r.multiHandLandmarks){scaleTarget*=0.98;return;}

 if(r.multiHandLandmarks.length===1){
  const p=r.multiHandLandmarks[0][0];
  if(lastPalm){
   const dx=(p.x-lastPalm.x)*80;
   const dy=(p.y-lastPalm.y)*-80;
   for(let i=0;i<velocities.length;i+=3){velocities[i]+=dx;velocities[i+1]+=dy}
  }
  lastPalm=p;
 }

 if(r.multiHandLandmarks.length===2){
  const h1=r.multiHandLandmarks[0];
  const h2=r.multiHandLandmarks[1];
  const d=Math.hypot(h1[4].x-h2[4].x,h1[4].y-h2[4].y);
  scaleTarget=THREE.MathUtils.clamp(d*3,.6,3);
  if(d<.08){
   for(let i=0;i<velocities.length;i+=3){
    velocities[i]+=(Math.random()-.5)*20;
    velocities[i+1]+=(Math.random()-.5)*20;
    velocities[i+2]+=(Math.random()-.5)*20;
   }
  }
 }
});

new Camera(video,{onFrame:async()=>hands.send({image:video}),width:640,height:480}).start();

document.getElementById('template').onchange=e=>shape(e.target.value);
document.getElementById('color').oninput=e=>material.uniforms.uColor.value.set(e.target.value);
document.getElementById('size').oninput=e=>material.uniforms.uSize.value=e.target.value;
document.getElementById('count').oninput=e=>{COUNT=parseInt(e.target.value);createParticles()};
document.getElementById('reload').onclick=()=>location.reload();

renderer.setAnimationLoop(()=>{
 particles.scale.lerp(new THREE.Vector3(scaleTarget,scaleTarget,scaleTarget),.15);
 for(let i=0;i<positions.length;i+=3){
  positions[i]+=velocities[i]*.08;
  positions[i+1]+=velocities[i+1]*.08;
  positions[i+2]+=velocities[i+2]*.08;
  velocities[i]*=.92;velocities[i+1]*=.92;velocities[i+2]*=.92;
 }
 geometry.attributes.position.needsUpdate=true;
 renderer.render(scene,camera);
});
</script>
</body>
</html>
